# Contributor: jv <jens@eisfair.org>
# Maintainer: jv <jens@eisfair.org>
pkgname=firebird
pkgver=2.1.5
pkgrel=0
pkgdesc="SQL SuperServer, based on InterBase 6.0 code"
url="http://www.firebirdsql.org"
arch="all"
license="GNU"
depends=""
depends_dev="icu-dev ncurses-dev"
makedepends="$depends_dev"
install="$pkgname.pre-install $pkgname.post-install"
subpackages="$pkgname-libs $pkgname-doc"
source="http://downloads.sourceforge.net/project/firebird/firebird/2.1.5-Release/Firebird-2.1.5.18497-0.tar.bz2
	firebird.initd
	firebird-libio.patch
	firebird-innetgr.patch
	firebird-honour-buildflags.patch
	firebird-cppflags.patch
	firebird-gcc-4.7.patch
	firebird-file-perms.patch
	firebird-log-path.patch
	firebird-charp-conversion.patch
	firebird-no-static-link.patch"

_builddir="$srcdir/Firebird-2.1.5.18497-0"

prepare() {
	local i
	cd ${_builddir}
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i ${srcdir}/$i || return 1;;
		esac
	done
	sleep 1
}

build() {
	cd ${_builddir}
	./configure --prefix=/usr/lib/firebird \
	--enable-superserver \
	--datadir=/var/firebird \
	--includedir=/usr/include \
	--disable-static \
	--without-system-editline \
	--with-system-icu || return 1
	sleep 1
	make -j1 || return 1
}

package() {
	cd ${_builddir}

	install -m 0755 -D ${srcdir}/$pkgname.initd \
		${pkgdir}/etc/init.d/$pkgname || return 1

	# superserver
	for f in fbserver fbguard fb_lock_print fbmgr.bin; do
		strip -R .note -R .comment ${_builddir}/gen/firebird/bin/$f
		install -m 0755 -D ${_builddir}/gen/firebird/bin/$f \
			${pkgdir}/usr/lib/firebird/bin/$f || return 1
	done

	# UDFs
	install -m 0644 -D ${_builddir}/gen/firebird/UDF/fbudf.so \
		${pkgdir}/usr/lib/firebird/UDF/fbudf.so || return 1
	install -m 0644 -D ${_builddir}/gen/firebird/UDF/ib_udf.so \
		${pkgdir}/usr/lib/firebird/UDF/ib_udf.so || return 1
	install -m 0644 -D ${_builddir}/src/extlib/fbudf/fbudf.sql \
		${pkgdir}/usr/lib/firebird/UDF/fbudf.sql || return 1
	install -m 0644 -D ${_builddir}/src/extlib/ib_udf.sql \
		${pkgdir}/usr/lib/firebird/UDF/ib_udf.sql || return 1
	install -m 0644 -D ${_builddir}/src/extlib/ib_udf2.sql \
		${pkgdir}/usr/lib/firebird/UDF/ib_udf2.sql || return 1

	# defaults
	install -m 0644 ${_builddir}/gen/firebird/security2.fdb \
		${pkgdir}/usr/lib/firebird/security2.fdb.default || return 1
	install -m 0644 ${_builddir}/gen/firebird/de_DE.msg \
		${pkgdir}/usr/lib/firebird/de_DE.msg || return 1
	install -m 0644 ${_builddir}/gen/firebird/firebird.msg \
		${pkgdir}/usr/lib/firebird/firebird.msg || return 1
	install -m 0644 ${_builddir}/gen/firebird/fr_FR.msg \
		${pkgdir}/usr/lib/firebird/fr_FR.msg || return 1
	install -m 0644 -D ${_builddir}/gen/firebird/help/help.fdb \
		${pkgdir}/usr/lib/firebird/help/help.fdb || return 1

	# utils
	mkdir -p ${pkgdir}/usr/bin
	cd ${pkgdir}/usr/bin
	for f in gbak gdef gfix gpre qli gsec gstat isql nbackup;
	do
		strip -R .note -R .comment ${_builddir}/gen/firebird/bin/$f
		install -m 0755 -D ${_builddir}/gen/firebird/bin/$f \
			${pkgdir}/usr/lib/firebird/bin/$f || return 1
		target="$f"
		if [ "$f" = "gstat" ]
		then
			target="fbstat"
		elif [ "$f" = "isql" ]
		then
			target="isql-fb"
		fi
		ln -sf ../lib/firebird/bin/$f ${pkgdir}/usr/bin/$target
	done
	cd ${_builddir}

	strip -R .note -R .comment ${_builddir}/gen/firebird/intl/libfbintl.so
	install -m 0644 -D ${_builddir}/gen/firebird/intl/libfbintl.so \
		${pkgdir}/usr/lib/firebird/intl/fbintl.so || return 1
	install -m 0644 -D ${_builddir}/gen/firebird/misc/fbintl.conf \
		${pkgdir}/usr/lib/firebird/intl/fbintl.conf || return 1
	install -m 0644 -D ${_builddir}/gen/firebird/misc/firebird.conf \
		${pkgdir}/usr/lib/firebird/firebird.conf || return 1

	strip -R .note -R .comment ${_builddir}/gen/firebird/lib/*.so.*
	mkdir -p ${pkgdir}/usr/lib/firebird/lib
	rm -f ${_builddir}/gen/firebird/lib/*.a
	cp -f ${_builddir}/gen/firebird/lib/* ${pkgdir}/usr/lib/firebird/lib/
	chmod 0644 ${pkgdir}/usr/lib/firebird/lib/*
	rm -f ${pkgdir}/usr/lib/firebird/lib/libfbclient*
	sed -i -e "s|^#TempDirectories.*|TempDirectories = /var/firebird|" ${pkgdir}/usr/lib/firebird/firebird.conf
	sed -i -e "s|^#DatabaseAccess.*|DatabaseAccess = Full|" ${pkgdir}/usr/lib/firebird/firebird.conf
}

libs() {
	pkgdesc="Firebird SQL client library"
	install -m 0644 -D ${_builddir}/gen/firebird/lib/libfbclient.so.$pkgver \
		${subpkgdir}/usr/lib/libfbclient.so.$pkgver || return 1
	cd ${subpkgdir}/usr/lib
	ln -sf libfbclient.so.$pkgver libfbclient.so.2
}

doc() {
	pkgdesc="Firebird SQL doc"
	arch="noarch"
	install -m 0644 -D ${_builddir}/doc/Firebird_conf.txt \
		${subpkgdir}/usr/share/doc/firebird/Firebird_conf.txt || return 1
	cp -f ${_builddir}/doc/sql.extensions/* ${subpkgdir}/usr/share/doc/firebird/
}

md5sums="70e1071fe030f00ae04c372082653eb4  Firebird-2.1.5.18497-0.tar.bz2
540730271ce7d61c4ee7f9b8cfc89fc9  firebird.initd
c58e789176a992a64ad6cff7b26b547a  firebird-libio.patch
5ae2806faec1fa6cac241367de6d368a  firebird-innetgr.patch
b2a434c67234e789a5d744de67a04931  firebird-honour-buildflags.patch
ca7c2cc442ab4bfccd3c404c5b5c27ff  firebird-cppflags.patch
399b739975be4c01f26e799111501009  firebird-gcc-4.7.patch
3542effab077c1eb65df32792b729664  firebird-file-perms.patch
16f4cf5559e7fa174032db858ba3db50  firebird-log-path.patch
957d017e62a49e610b643484cf14b9c6  firebird-charp-conversion.patch
7e2b683acb9a6c5e5f8175d9893b2488  firebird-no-static-link.patch"
sha256sums="8eaf5910ccee12af8f6abc17747cdea2c3ff4e6bee381a870d192679a44f83eb  Firebird-2.1.5.18497-0.tar.bz2
c7c575138aadb471fc950bd49a39a5a903bcf03b0d463e691d245a62c76d1a50  firebird.initd
9a59a58ba4c2edf4a77a531377c4bb4eae9966bf1f12277c3d46eb62f762f92e  firebird-libio.patch
6500a16fbb151e0d115e71812be661dc3b8d12b19af671ed4fd86626159b6faa  firebird-innetgr.patch
780d9271735309bba08181c96230880e4a6f0b74135ddd032cf5dcb8ac6126f7  firebird-honour-buildflags.patch
669c334eadfff908aab989a3043031fcaedcc7e004ef64d40bdef768f5142cd8  firebird-cppflags.patch
0fe6ccdef87801b05db93bd3395f234cbb6deb5e2ff669799408e4ab1f3b1dc0  firebird-gcc-4.7.patch
0a9473b7f650b81a1d98f518e66ecdd90600fa45182d2f44b10c99c3ab0dbcca  firebird-file-perms.patch
44a1919bea092adb421571efba1bbbcfc5b05c2fe13b74fb5b1b670f6a411e57  firebird-log-path.patch
2810cd702e0080306d9fa78c627d0b135ca29aafec2e425aa54c4f735288448f  firebird-charp-conversion.patch
c55995d5bbbd5cbfab1382a69c0403eec83618716f2cbd71ab90e3b97913d75f  firebird-no-static-link.patch"
sha512sums="2c0afab35a20741a19dd005cdc9a479306e56a15e8f4f62cffd6c628355464ddd3ffc8a3ee772bd89a2392db86b7d773e794a5d819b4c857be258ad976a1e00d  Firebird-2.1.5.18497-0.tar.bz2
41728e2537ac68dbcc08cc0d97bfde53102366632e0df521d4ab5bebace7a01b0c6f43416667e896fa2a1fd2b4e7b55b5e477a8245b7f3e2bc4bbb7665fb2c8c  firebird.initd
8ae0a6e2d63a0e00cc3a051f6cd62d8dbc0d0fcb77ed0ff8de60ebbe4edc6b1a372487570192b34514216cb01e0ff4b1fd23cded2b421a98a7d0e347eaf12429  firebird-libio.patch
ad0c91aa38216020f395b6d45fe069f5e15f2725a2b1a5ce43a85213ce259b670d65907d2c2f6a07a705d656731ee170f92ab376eef8f931a13e6062f0f8041c  firebird-innetgr.patch
46392a5d562d98bf7f4936b064e29e32f62473c592770ed10ea1fb37a6a2a598dd6e1957ecb03a7dce84920bfb27eac50fcfea00715174d9143d96240911008f  firebird-honour-buildflags.patch
e00c4021d93b390fa7d512e05ca5f62c20ba882d05e39856f5c5fc8d83f077d3ddec7dae22070c174a79c2140a48f9caedb69e85042e9cade8ea11d1afce9655  firebird-cppflags.patch
38500c1e05321bbe182e3cb6d15d10ed6efc2c53cd192d4b2445f84066c8db6defff884da2de2222fd8172b377dfe2806b31896ba695dff7eae67b54bfbcf3a8  firebird-gcc-4.7.patch
ee30117296649100df7ee4afba9cd55604b4b1f8bc1bf7c62478278e4df4f23fcf55fa7ddcd6ee8c48d29e4eb266cdc3b1c37c60d843b2ce47b912ad5f2f252a  firebird-file-perms.patch
c9c38785e29a25140687b5ab3e474b37e931c9463166e332e523921edfd08e72e7e312a23b44299cf5f5197e4a6f94f37803b785e44303fae2d643c21f3f2599  firebird-log-path.patch
e41b6158a78addbca4e4c629d2d189e822de3d9f6249a4bc1fb2fb6db5e0f88abcd0c6e30718c51d0ebf0d49ea9211e17db7c5dcd3b9ada30946ca0026ed22a2  firebird-charp-conversion.patch
ecf132e70ceaeefcd543a6669af2c818bb3de481fd2db0ec4c40d617643aa6b075fc5e9920e7172402ef5f6234ea34fd5c858926ef040157195b63c79b30a31c  firebird-no-static-link.patch"
