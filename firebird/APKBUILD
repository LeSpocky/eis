# Contributor: jv <jens@eisfair.org>
# Maintainer: jv <jens@eisfair.org>
pkgname=firebird
pkgver=2.5.3
pkgrel=0
pkgdesc="SQL SuperServer, based on InterBase 6.0 code"
url="http://www.firebirdsql.org"
arch="all"
license="GNU"
depends=""
depends_dev="icu-dev ncurses-dev libedit-dev"
makedepends="$depends_dev"
install="$pkgname.pre-install $pkgname.post-install"
subpackages="$pkgname-libs $pkgname-doc"
source="http://sourceforge.net/projects/firebird/files/firebird/${pkgver}-Release/Firebird-2.5.3.26778-0.tar.bz2
	firebird-rwlock.patch
	firebird-libio.patch
	firebird.initd"

_builddir="$srcdir/Firebird-2.5.3.26778-0"

prepare() {
	local i
	cd ${_builddir}
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i ${srcdir}/$i || return 1;;
		esac
	done
	sleep 1
}

build() {
	cd ${_builddir}
	./configure --prefix=/usr/lib/firebird \
	--enable-superserver \
	--datadir=/var/firebird \
	--includedir=/usr/include \
	--with-fbudf=/usr/lib/firebird/UDF \
	--with-fbhelp=/usr/lib/firebird/help \
	--with-fbintl=/usr/lib/firebird/intl \
	--with-fbsecure-db=/usr/lib/firebird \
	--with-fbmsg=/usr/lib/firebird \
	--with-fblog=/var/log/firebird/ \
	--with-fbglock=/run/firebird \
	--with-fbplugins=/usr/lib/firebird/plugins \
	--with-system-editline \
	--enable-system-icu || return 1
	sleep 1
	make -j1 || return 1
}

package() {
	cd ${_builddir}

	install -m 0755 -D ${srcdir}/$pkgname.initd \
		${pkgdir}/etc/init.d/$pkgname || return 1

	# superserver
	for f in fbserver fbguard fb_lock_print fbmgr.bin; do
		strip -R .note -R .comment ${_builddir}/gen/firebird/bin/$f
		install -m 0755 -D ${_builddir}/gen/firebird/bin/$f \
			${pkgdir}/usr/lib/firebird/bin/$f || return 1
	done

	# UDFs
	install -m 0644 -D ${_builddir}/gen/firebird/UDF/fbudf.so \
		${pkgdir}/usr/lib/firebird/UDF/fbudf.so || return 1
	install -m 0644 -D ${_builddir}/gen/firebird/UDF/ib_udf.so \
		${pkgdir}/usr/lib/firebird/UDF/ib_udf.so || return 1
	install -m 0644 -D ${_builddir}/src/extlib/fbudf/fbudf.sql \
		${pkgdir}/usr/lib/firebird/UDF/fbudf.sql || return 1
	install -m 0644 -D ${_builddir}/src/extlib/ib_udf.sql \
		${pkgdir}/usr/lib/firebird/UDF/ib_udf.sql || return 1
	install -m 0644 -D ${_builddir}/src/extlib/ib_udf2.sql \
		${pkgdir}/usr/lib/firebird/UDF/ib_udf2.sql || return 1

	# defaults
	install -m 0644 ${_builddir}/gen/firebird/security2.fdb \
		${pkgdir}/usr/lib/firebird/security2.fdb.default || return 1
	install -m 0644 ${_builddir}/gen/firebird/de_DE.msg \
		${pkgdir}/usr/lib/firebird/de_DE.msg || return 1
	install -m 0644 ${_builddir}/gen/firebird/firebird.msg \
		${pkgdir}/usr/lib/firebird/firebird.msg || return 1
	install -m 0644 ${_builddir}/gen/firebird/fr_FR.msg \
		${pkgdir}/usr/lib/firebird/fr_FR.msg || return 1
	install -m 0644 -D ${_builddir}/gen/firebird/help/help.fdb \
		${pkgdir}/usr/lib/firebird/help/help.fdb || return 1

	# utils
	mkdir -p ${pkgdir}/usr/bin
	cd ${pkgdir}/usr/bin
	for f in gbak gdef gfix gpre qli gsec gstat isql nbackup;
	do
		strip -R .note -R .comment ${_builddir}/gen/firebird/bin/$f
		install -m 0755 -D ${_builddir}/gen/firebird/bin/$f \
			${pkgdir}/usr/lib/firebird/bin/$f || return 1
		target="$f"
		if [ "$f" = "gstat" ]
		then
			target="fbstat"
		elif [ "$f" = "isql" ]
		then
			target="isql-fb"
		fi
		ln -sf ../lib/firebird/bin/$f ${pkgdir}/usr/bin/$target
	done
	cd ${_builddir}

	strip -R .note -R .comment ${_builddir}/gen/firebird/intl/libfbintl.so
	install -m 0644 -D ${_builddir}/gen/firebird/intl/libfbintl.so \
		${pkgdir}/usr/lib/firebird/intl/fbintl.so || return 1
	install -m 0644 -D ${_builddir}/gen/install/misc/fbintl.conf \
		${pkgdir}/usr/lib/firebird/intl/fbintl.conf || return 1
	install -m 0644 -D ${_builddir}/gen/install/misc/firebird.conf \
		${pkgdir}/usr/lib/firebird/firebird.conf || return 1
	install -m 0644 -D ${_builddir}/gen/install/misc/aliases.conf \
		${pkgdir}/usr/lib/firebird/aliases.conf || return 1

	strip -R .note -R .comment ${_builddir}/gen/firebird/lib/*.so.*
	mkdir -p ${pkgdir}/usr/lib/firebird/lib
	rm -f ${_builddir}/gen/firebird/lib/*.a
	cp -f ${_builddir}/gen/firebird/lib/* ${pkgdir}/usr/lib/firebird/lib/
	chmod 0644 ${pkgdir}/usr/lib/firebird/lib/*
	rm -f ${pkgdir}/usr/lib/firebird/lib/libfbclient*
	sed -i -e "s|^#TempDirectories.*|TempDirectories = /var/firebird|" ${pkgdir}/usr/lib/firebird/firebird.conf
	sed -i -e "s|^#DatabaseAccess.*|DatabaseAccess = Full|" ${pkgdir}/usr/lib/firebird/firebird.conf
}

libs() {
	pkgdesc="Firebird SQL client library"
	install -m 0644 -D ${_builddir}/gen/firebird/lib/libfbclient.so.$pkgver \
		${subpkgdir}/usr/lib/libfbclient.so.$pkgver || return 1
	cd ${subpkgdir}/usr/lib
	ln -sf libfbclient.so.$pkgver libfbclient.so.2
}

doc() {
	pkgdesc="Firebird SQL doc"
	arch="noarch"
	install -m 0644 -D ${_builddir}/doc/Firebird_conf.txt \
		${subpkgdir}/usr/share/doc/firebird/Firebird_conf.txt || return 1
	cp -f ${_builddir}/doc/sql.extensions/* ${subpkgdir}/usr/share/doc/firebird/
}

md5sums="5feff765e11a5fb0ec17c71e155bb974  Firebird-2.5.3.26778-0.tar.bz2
d1dc4f745dd33d6ad4576b826ba1d35f  firebird-rwlock.patch
c58e789176a992a64ad6cff7b26b547a  firebird-libio.patch
69cd883920847987d72a964c2159c337  firebird.initd"
sha256sums="d4c561185e5df1c24b9c19d335d178b82d03bd15bab4963d2bc374eb75d41c4b  Firebird-2.5.3.26778-0.tar.bz2
42fa0990c1243bd89b49152d100533d921407b22bfb1ac76719861d43efb1d2a  firebird-rwlock.patch
9a59a58ba4c2edf4a77a531377c4bb4eae9966bf1f12277c3d46eb62f762f92e  firebird-libio.patch
a78c44f71ef9ec54647982b77a46af6384e175c63650a7c7df935f88dc24d0e0  firebird.initd"
sha512sums="4d2e97791bdb8445ceff6686cffb2f78e315591e1f8b5d355d8006003218d78212c788bb29b1e3323235c6d63f19d82ad30cfddd94267d9079d4963ddf88b185  Firebird-2.5.3.26778-0.tar.bz2
c2e1314b8817c46a8d079c7188ff4f412ffaf97c1aa423e71011a733fa8eedf01af41e179c10bba9b80883c4be0bbb24c61f3226a439fd656a025140915d8916  firebird-rwlock.patch
8ae0a6e2d63a0e00cc3a051f6cd62d8dbc0d0fcb77ed0ff8de60ebbe4edc6b1a372487570192b34514216cb01e0ff4b1fd23cded2b421a98a7d0e347eaf12429  firebird-libio.patch
5f1360d9a6ec77b389f77c3ad430c344f7328de1016b4af241d01161edf72b7359d206e6ec5b4fde8848fa5aedd0bece953098adf85b2c0c76796cc88806e16e  firebird.initd"
