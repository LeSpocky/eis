# Contributor: eisfair team team@eisfair.org
# Maintainer: daniel@eisfair.org, jens@eisfair.org
pkgname=libcui
pkgver=2.0.0
pkgrel=9
pkgdesc="Eisfair CUI basis libs"
url="http://www.eisfair.org"
arch="all"
license="GPL"
depends=""
_alpinerelease=`awk -F \. {'print $1$2'} /etc/alpine-release`
if [ "$_alpinerelease" -gt 31 ]
then
  depends_dev="coreutils ncurses-dev ncurses-widec-libs flex openssl-dev mariadb-dev postgresql-dev"
else
  depends_dev="coreutils ncurses-dev ncurses-widec-libs libiconv-dev flex openssl-dev mysql-dev postgresql-dev"
fi
makedepends="$depends_dev"
install=""
subpackages="$pkgname-dev $pkgname-addonmysql $pkgname-addonpgsql $pkgname-addonpwdfile"
source=""

_builddir="$srcdir/$pkgname"

prepare() {
	local i
	cp -r libcui "$srcdir/"
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	make -j1 -s || return 1
	ln -sf libcui-script.so.${pkgver} libcui-script.so
	ln -sf libcui-util.so.${pkgver} libcui-util.so
	ln -sf libcui.so.${pkgver} libcui.so
	echo "___Build addons:___"
	cd ${_builddir}/addons/libapk-addon
	make -j1 -s || return 1
	cd ${_builddir}/addons/libmysql-addon
	make -j1 -s || return 1
	cd ${_builddir}/addons/libpgsql-addon
	make -j1 -s || return 1
	cd ${_builddir}/addons/libpwdfile-addon
	make -j1 -s || return 1	
	cd ${_builddir}/addons/libsys-addon
	make -j1 -s || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir/" install || return 1
	mkdir -p ${pkgdir}/var/install/include
	cp -f cuilib ${pkgdir}/var/install/include/
	mkdir -p ${pkgdir}/usr/lib/cui-addons
	cd ${_builddir}/addons/libapk-addon
	make DESTDIR=${pkgdir}/ install || return 1
	cd ${_builddir}/addons/libsys-addon
	make DESTDIR=${pkgdir}/ install || return 1
	rm ${pkgdir}/usr/lib/*.so
}

dev(){
	pkgdesc="CUI lib devel package"
	depends="libcui>=$pkgver"
	rm -rf ${pkgdir}/usr/include
	rm -f ${pkgdir}/usr/lib/*.a
	mkdir -p ${subpkgdir}/usr/lib || return 1
	mkdir -p ${subpkgdir}/usr/include || return 1
	mv ${_builddir}/*.a ${subpkgdir}/usr/lib/ || return 1
	cp ${_builddir}/cui.h ${subpkgdir}/usr/include/ || return 1
	cp ${_builddir}/cui-char.h ${subpkgdir}/usr/include/ || return 1
	cp ${_builddir}/cui-util.h ${subpkgdir}/usr/include/ || return 1
	cp ${_builddir}/cui-script.h ${subpkgdir}/usr/include/ || return 1
	# Don't strip libcui*.a files!
	# strip -R .note -R .comment ${subpkgdir}/usr/lib/*.a
	ln -sf libcui.so.${pkgver} ${subpkgdir}/usr/lib/libcui.so || return 1
	ln -sf libcui-script.so.${pkgver} ${subpkgdir}/usr/lib/libcui-script.so || return 1
	ln -sf libcui-util.so.${pkgver} ${subpkgdir}/usr/lib/libcui-util.so || return 1
}

addonmysql(){
	pkgdesc="CUI lib addon for MySQL database"
	depends="libcui>=$pkgver mysql-libs"
	cd ${_builddir}/addons/libmysql-addon
	make -j1 -s DESTDIR=${subpkgdir} install || return 1
}

addonpgsql(){
	pkgdesc="CUI lib addon for Postgresql database"
	depends="libcui>=$pkgver pgsql-libs"
	cd ${_builddir}/addons/libpgsql-addon
	make -j1 -s DESTDIR=${subpkgdir} install || return 1
}

addonpwdfile(){
	pkgdesc="CUI lib addon for flattext user:password files"
	depends="libcui>=$pkgver"
	cd ${_builddir}/addons/libpwdfile-addon
	make -j1 -s DESTDIR=${subpkgdir} install || return 1
}
